@page "/filePreview"
@using System.IO;
@using Microsoft.AspNetCore.Components.Forms
@inject HttpClient Http

<h3>File Preview Component</h3>

<span id="exception-message">@exceptionMessage</span>

@if (isLoading)
{
    <p>Loading...</p>
    <br />
}

@foreach (var (file, content) in loadedFiles)
{
    <p id="file-@(file.Name)">
        <strong>Name:</strong> <span id="file-name">@(file.Name)</span><br />
        <strong>Last modified:</strong> <span id="file-last-modified">@(file.LastModified.ToString())</span><br />
        <strong>Size (bytes):</strong> <span id="file-size">@(file.Size)</span><br />
        <strong>Content type:</strong> <span id="file-content-type">@(file.ContentType)</span><br />
        <strong>Content:</strong> <span id="file-content">@content</span><br />
    </p>
}

<h3>Image upload (max 15MB)</h3>

<InputFile OnChange="LoadImage" id="input-image" />
<br />

@if (imageDataUri != null)
{
    <p>
        Uploaded image:<br />
        <img id="image-uploaded" src="@imageDataUri" />
    </p>
}
<button @onclick="RunPython">Process</button>
<button @onclick="LogSomething">Bigoss</button>

@if (processingFinished) {
    <p>
        Processed data:
        @data
    </p>
}

@code {
    Dictionary<IBrowserFile, string> loadedFiles = new Dictionary<IBrowserFile, string>();

    long maxFileSize = 1024 * 1024 * 15;
    int maxAllowedFiles = 3;

    bool processingFinished = false;

    string data;

    bool isLoading;

    string imageDataUri;

    string exceptionMessage;

    private class Request
    {
        public string source { get; set; }
        public string content { get; set; }
        public string formated { get; set; }
        
    }

    private class Response 
    {
        public string formated {get;set;}
    }


    async Task LoadFiles(InputFileChangeEventArgs e)
    {
        isLoading = true;
        loadedFiles.Clear();
        exceptionMessage = string.Empty;

        try
        {
            foreach (var file in e.GetMultipleFiles(maxAllowedFiles))
            {
                StateHasChanged();

                using var reader = new StreamReader(file.OpenReadStream(maxFileSize));

                loadedFiles.Add(file, await reader.ReadToEndAsync());
            }
        }
        catch (Exception ex)
        {
            exceptionMessage = ex.Message;
        }

        isLoading = false;
    }

    async Task RunPython(){
        var payload = new Request {source = "latex", content = "simple" };
        
        var response = await Http.PostAsJsonAsync("http://localhost:7000/convert/simple",payload);
        var content = response.Content.ReadFromJsonAsync<Response>();
        if (content.IsCompletedSuccessfully){
            Console.WriteLine("My debug output.");
        }
    }

    void LogSomething(){
        Console.WriteLine("My debug output.");
    }

    async Task LoadImage(InputFileChangeEventArgs e)
    {
        var format = "image/jpeg";
        var imageFile = await e.File.RequestImageFileAsync(format, 640, 480);

        using var fileStream = imageFile.OpenReadStream(maxFileSize);
        using var memoryStream = new MemoryStream();
        await fileStream.CopyToAsync(memoryStream);

        imageDataUri = $"data:{format};base64,{Convert.ToBase64String(memoryStream.ToArray())}";
    }
    
}